# ğŸ¬ Mail Video Service

> **Ná»n táº£ng SaaS tá»± Ä‘á»™ng táº¡o video email cÃ¡ nhÃ¢n hÃ³a vá»›i AI Avatar**

Biáº¿n email thÃ´ng thÆ°á»ng thÃ nh video tÆ°Æ¡ng tÃ¡c vá»›i AI Avatar cá»§a báº¡n, tÄƒng engagement lÃªn 300% vÃ  conversion rate lÃªn 200%.

---

## ğŸ’¡ Ã TÆ°á»Ÿng Dá»± Ãn

### Váº¥n Äá» Cáº§n Giáº£i Quyáº¿t

ğŸ“§ **Email truyá»n thá»‘ng khÃ´ng cÃ²n hiá»‡u quáº£:**
- Open rate tháº¥p (trung bÃ¬nh 21%)
- Click-through rate kÃ©m (trung bÃ¬nh 2.6%)
- Thiáº¿u tÃ­nh cÃ¡ nhÃ¢n hÃ³a
- Dá»… bá»‹ bá» qua trong há»™p thÆ° Ä‘áº§y

ğŸ¯ **Giáº£i phÃ¡p:** Tá»± Ä‘á»™ng hÃ³a viá»‡c táº¡o video email vá»›i AI Avatar cÃ¡ nhÃ¢n, mang láº¡i:
- **TÄƒng Open Rate**: Video thumbnail trong email thu hÃºt hÆ¡n text thuáº§n tÃºy
- **TÄƒng Engagement**: Video cÃ¡ nhÃ¢n táº¡o káº¿t ná»‘i máº¡nh máº½ vá»›i ngÆ°á»i nháº­n
- **Tiáº¿t Kiá»‡m Thá»i Gian**: Tá»± Ä‘á»™ng táº¡o hÃ ng trÄƒm video tá»« template
- **Scalable**: Phá»¥c vá»¥ tá»« cÃ¡ nhÃ¢n Ä‘áº¿n doanh nghiá»‡p lá»›n

### Workflow ChÃ­nh

```mermaid
graph LR
    A[User Upload Photo + Voice] --> B[Táº¡o AI Avatar]
    B --> C[Viáº¿t Email Script]
    C --> D[AI Text-to-Speech]
    D --> E[Video Generation]
    E --> F[Gá»­i Email vá»›i Video]
    F --> G[Tracking & Analytics]
```

### Use Cases Thá»±c Táº¿

1. **Sales & Marketing**
   - Cold email outreach vá»›i video giá»›i thiá»‡u
   - Follow-up khÃ¡ch hÃ ng tiá»m nÄƒng
   - Product demo cÃ¡ nhÃ¢n

2. **Customer Success**
   - Onboarding video cho khÃ¡ch hÃ ng má»›i
   - Support tickets vá»›i video hÆ°á»›ng dáº«n
   - Thank you messages

3. **HR & Recruitment**
   - Job offer letters vá»›i video
   - Welcome aboard videos
   - Training materials

4. **Real Estate**
   - Property tour intro videos
   - Personalized follow-ups
   - Market updates

---

## ğŸ—ï¸ Kiáº¿n TrÃºc Há»‡ Thá»‘ng

### Tá»•ng Quan

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Outlook Add-in  â”‚ â†â”€â”€â”€ User Interface (Office.js)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin Portal   â”‚ â†â”€â”€â”€ Dashboard (React + Vite)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ REST API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         FastAPI Backend                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Auth   â”‚  â”‚  Avatar  â”‚  â”‚ Video â”‚ â”‚
â”‚  â”‚ Service  â”‚  â”‚ Service  â”‚  â”‚Serviceâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚ Postgreâ”‚    â”‚   MinIO    â”‚
    â”‚   SQL  â”‚    â”‚  Storage   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  External API â”‚
    â”‚ - Heygen      â”‚
    â”‚ - OpenAI GPT  â”‚
    â”‚ - SendGrid    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Video Generation Pipeline

**Option 1: Heygen Lip-Sync (Recommended for Production)**

```
Input: Text Script + Avatar Photo
         â†“
    [1. Create Heygen Avatar] (One-time)
         â†“ Upload photo to Heygen API
    Heygen Avatar ID
         â†“
    [2. Generate Video Request]
         â†“ POST /v2/video/generate
    Video ID + Status: "processing"
         â†“
    [3. Async Polling] (30-60s)
         â†“ GET /v2/video/{id} every 10s
    Status: "completed" + Video URL
         â†“
    [4. Download from Heygen CDN]
         â†“ HTTPS download
    Video File (.mp4) with Lip-Sync
         â†“
    [5. Upload to MinIO]
         â†“ S3-compatible storage
    Final Video URL
         â†“
    [6. Database Update]
         â†“ Status: completed
    Ready for Email Delivery
```

**Option 2: Static Image + Audio (Fallback/Demo)**

```
Input: Text Script + Avatar Photo
         â†“
    [1. Text-to-Speech]
         â†“ gTTS / Google Cloud TTS
    Audio File (.mp3)
         â†“
    [2. Image Processing]
         â†“ Download/Fetch Avatar Photo
    Image File (.jpg)
         â†“
    [3. FFmpeg Video Creation]
         â†“ Merge Audio + Static Image
    Video File (.mp4) 720x1280
         â†“
    [4. Upload to MinIO]
         â†“ S3-compatible storage
    Video URL
         â†“
    [5. Database Update]
         â†“ Status: completed
    Ready for Email Delivery
```

**Comparison:**

| Feature | Heygen Lip-Sync | Static (Current) |
|---------|----------------|------------------|
| **Lip Movement** | âœ… Professional | âŒ None |
| **Generation Time** | 30-60s | ~10s |
| **Cost** | $0.10-0.50/video | Free |
| **Requirements** | API Key | None |
| **Quality** | High | Basic |



---

## ğŸ› ï¸ Tech Stack

### Backend
| Technology | Purpose | LÃ½ do chá»n |
|------------|---------|-----------|
| **FastAPI** | REST API framework | Hiá»‡u suáº¥t cao, async native, OpenAPI auto-docs |
| **PostgreSQL** | Database chÃ­nh | ACID compliance, JSON support, mature |
| **SQLAlchemy** | ORM async | Type-safe, migration support |
| **JWT** | Authentication | Stateless, secure, scalable |
| **MinIO** | Object Storage | S3-compatible, self-hosted, cost-effective |

### AI/Video Processing
| Technology | Purpose | LÃ½ do chá»n |
|------------|---------|-----------|
| **gTTS** | Text-to-Speech | Free, Ä‘a ngÃ´n ngá»¯, khÃ´ng cáº§n API key |
| **FFmpeg** | Video processing | Industry standard, máº¡nh máº½, Ä‘a format |
| **Heygen API** | Advanced Avatar | Lip-sync cháº¥t lÆ°á»£ng cao, professional |
| **SadTalker** | Local lip-sync | Self-hosted, GPU acceleration, privacy |

### Frontend
| Technology | Purpose |
|------------|---------|
| **React 18** | UI framework |
| **Vite** | Build tool (Admin Portal) |
| **Office.js** | Outlook integration |
| **Recharts** | Analytics dashboard |

### Infrastructure
| Technology | Purpose |
|------------|---------|
| **Docker Compose** | Container orchestration |
| **Nginx** | Reverse proxy |

---

## ğŸš€ Quick Start

### Prerequisites
- Docker Desktop
- Git

### 1. Clone Repository

```bash
git clone <repository-url>
cd mail-video-service
```

### 2. Setup Environment

```bash
copy .env.example .env
```

**Cáº¥u hÃ¬nh tá»‘i thiá»ƒu:**
```env
SECRET_KEY=your-secret-key-change-in-production
DATABASE_URL=postgresql://postgres:postgres@db:5432/mail_video_service
MINIO_ENDPOINT=minio:9000
```

**Heygen API (Recommended - Lip-Sync Videos):**

> [!IMPORTANT]
> **Äá»ƒ cÃ³ chuyá»ƒn Ä‘á»™ng mÃ´i miá»‡ng (lip-sync)**, báº¡n cáº§n Ä‘Äƒng kÃ½ Heygen API:
> 
> 1. ÄÄƒng kÃ½ táº¡i: https://app.heygen.com/
> 2. Navigate to: Settings â†’ API Keys
> 3. Create new API key â†’ Copy

```env
# Heygen API for lip-sync videos
HEYGEN_API_KEY=sk_V2_your_heygen_api_key_here
HEYGEN_API_URL=https://api.heygen.com
```

**Without Heygen**: Há»‡ thá»‘ng váº«n hoáº¡t Ä‘á»™ng, nhÆ°ng videos sáº½ lÃ  **static images** (áº£nh tÄ©nh + audio).

**Optional APIs (nÃ¢ng cao):**
```env
# OpenAI (email summarization)
OPENAI_API_KEY=your-openai-api-key

# SendGrid (email delivery)
SENDGRID_API_KEY=your-sendgrid-api-key
FROM_EMAIL=noreply@yourdomain.com
```


### 3. Start Services

```bash
docker-compose up -d --build
```

### 4. Access Services

| Service | URL | Credentials |
|---------|-----|-------------|
| **API Docs** | http://localhost:8000/docs | - |
| **Admin Portal** | http://localhost:3000 | - |
| **MinIO Console** | http://localhost:9001 | minioadmin / minioadmin |

### 5. Demo Test

**A. Authorize API:**
1. Má»Ÿ http://localhost:8000/docs
2. Click **Authorize**
3. Login: `admin@demo.com` / `admin123`

**B. Upload Avatar Photo:**
- Endpoint: `POST /api/v1/avatars/{avatar_id}/upload-photo`
- avatar_id: `605f28ea-8094-4356-b8b3-09f7e2229425`
- Upload áº£nh chÃ¢n dung

**C. Táº¡o Video:**
- Endpoint: `POST /api/v1/videos/`
```json
{
  "avatar_id": "605f28ea-8094-4356-b8b3-09f7e2229425",
  "script": "Xin chÃ o! TÃ´i lÃ  AI Avatar cá»§a báº¡n."
}
```

**D. Xem Video:**
- Sau 10-15 giÃ¢y, vÃ o MinIO Console
- Bucket: `videos` â†’ tÃ¬m video theo ID

---

## ğŸ“ Project Structure

```
mail-video-service/
â”œâ”€â”€ backend/                 # FastAPI Backend
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ api/v1/         # REST endpoints
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py     # Authentication
â”‚   â”‚   â”‚   â”œâ”€â”€ avatars.py  # Avatar management
â”‚   â”‚   â”‚   â”œâ”€â”€ videos.py   # Video generation
â”‚   â”‚   â”‚   â””â”€â”€ emails.py   # Email handling
â”‚   â”‚   â”œâ”€â”€ core/           # Core modules
â”‚   â”‚   â”‚   â”œâ”€â”€ config.py   # Settings
â”‚   â”‚   â”‚   â”œâ”€â”€ security.py # JWT, password
â”‚   â”‚   â”‚   â””â”€â”€ database.py # DB connection
â”‚   â”‚   â”œâ”€â”€ models/         # SQLAlchemy models
â”‚   â”‚   â”œâ”€â”€ schemas/        # Pydantic schemas
â”‚   â”‚   â””â”€â”€ services/       # Business logic
â”‚   â”‚       â”œâ”€â”€ video_service.py
â”‚   â”‚       â”œâ”€â”€ avatar_service.py
â”‚   â”‚       â””â”€â”€ storage_service.py
â”‚   â”œâ”€â”€ alembic/            # Database migrations
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ ai/                     # AI Pipeline (GPU)
â”‚   â”œâ”€â”€ video_pipeline.py   # SadTalker integration
â”‚   â””â”€â”€ Dockerfile.gpu
â”œâ”€â”€ admin-portal/           # React Dashboard
â”‚   â””â”€â”€ src/
â”œâ”€â”€ outlook-addin/          # Office Add-in
â”‚   â”œâ”€â”€ manifest.xml
â”‚   â””â”€â”€ src/
â””â”€â”€ docker-compose.yml
```

---

## ğŸ¯ Core Features

### âœ… Implemented

- [x] **Multi-tenant Architecture** - Há»— trá»£ nhiá»u organization
- [x] **Avatar Management** - Upload photo, voice samples
- [x] **Video Generation** - Text â†’ TTS â†’ Video
  - âœ… Static video (áº£nh tÄ©nh + audio) - Working
  - âœ… Heygen API integration - Ready (cáº§n API key Ä‘á»ƒ enable)
- [x] **S3 Storage** - MinIO for video/image storage
- [x] **REST API** - FastAPI with OpenAPI docs
- [x] **Authentication** - JWT-based auth
- [x] **Database Migrations** - Alembic for schema changes

### ğŸš§ Ready to Enable

- [ ] **Heygen Lip-Sync** - Professional talking avatar (cáº§n thÃªm API key)
  - âœ… Service created (`heygen_service.py`)
  - âœ… Avatar service integrated
  - [ ] Database migration (`heygen_avatar_id` field)
  - [ ] End-to-end testing

### ğŸ“‹ Planned Features

- [ ] **SendGrid Integration** - Automated email delivery
- [ ] **Outlook Add-in** - In-email video creation
- [ ] **Analytics Dashboard** - Video performance tracking
- [ ] **Voice Cloning** - Custom voice generation
- [ ] **Template Library** - Pre-built email templates
- [ ] **A/B Testing** - Video variant testing


---

## ğŸ“Š Performance Metrics

### Current Results (Demo)

| Metric | Value |
|--------|-------|
| **Video Generation** | ~10 giÃ¢y (simple static) |
| **Audio Duration** | TÆ°Æ¡ng á»©ng vá»›i text length |
| **Video Quality** | 720x1280 (9:16 portrait) |
| **File Size** | ~250-300 KB cho 7 giÃ¢y |
| **Concurrent Videos** | 10+ (CPU mode) |

### Expected Production Metrics

| Metric | Target |
|--------|--------|
| **API Response Time** | < 200ms (p95) |
| **Video Generation** | < 30s (with GPU) |
| **Uptime** | 99.9% |
| **Max File Size** | 10 MB per video |

---

## ğŸ”§ Development

### Running Tests

```bash
# Backend tests
docker-compose exec backend pytest

# Frontend tests
cd admin-portal && npm test
```

### Database Migrations

```bash
# Create new migration
docker-compose exec backend alembic revision -m "description"

# Apply migrations
docker-compose exec backend alembic upgrade head

# Rollback
docker-compose exec backend alembic downgrade -1
```

### Logs

```bash
# All services
docker-compose logs -f

# Specific service
docker-compose logs -f backend

# Last N lines
docker-compose logs --tail=50 backend
```

---

## ğŸ“ API Documentation

Sau khi start services, API docs tá»± Ä‘á»™ng cÃ³ táº¡i:
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc
- **OpenAPI JSON**: http://localhost:8000/openapi.json

### Key Endpoints

#### Authentication
```http
POST /api/v1/auth/register
POST /api/v1/auth/login
```

#### Avatars
```http
GET    /api/v1/avatars/
POST   /api/v1/avatars/
POST   /api/v1/avatars/{id}/upload-photo
POST   /api/v1/avatars/{id}/upload-voice
POST   /api/v1/avatars/{id}/generate
```

#### Videos
```http
POST   /api/v1/videos/
GET    /api/v1/videos/{id}
GET    /api/v1/videos/
```

#### Emails
```http
POST   /api/v1/emails/summarize
POST   /api/v1/emails/send
```

---

## ğŸ” Security

- **JWT Authentication** - Bearer token vá»›i expiry
- **Password Hashing** - bcrypt vá»›i cost factor 12
- **CORS** - Configurable allowed origins
- **SQL Injection Protection** - SQLAlchemy ORM
- **File Upload Validation** - Type vÃ  size checking
- **Rate Limiting** - (TODO) Prevent API abuse

---

## ğŸ” Báº£o Máº­t & Quáº£n LÃ½ NgÆ°á»i DÃ¹ng

### Kiáº¿n TrÃºc Authentication

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant API
    participant Database
    
    User->>Frontend: Nháº­p email/password
    Frontend->>API: POST /auth/login
    API->>Database: TÃ¬m user theo email
    Database-->>API: User data + hashed_password
    API->>API: Verify password (bcrypt)
    API->>API: Create JWT token
    API-->>Frontend: {access_token, token_type}
    Frontend->>Frontend: LÆ°u token vÃ o localStorage
    
    Note over User,Database: CÃ¡c request sau Ä‘Ã³
    
    Frontend->>API: API Request + Bearer Token
    API->>API: Decode & validate JWT
    API->>Database: Get user details
    API-->>Frontend: Protected resource
```

### 1. User Registration

**Multi-tenant Architecture:**
- Má»—i Ä‘Äƒng kÃ½ táº¡o **Tenant** (organization) riÃªng
- User Ä‘áº§u tiÃªn tá»± Ä‘á»™ng lÃ  **Admin**
- Tenant isolation: User chá»‰ tháº¥y data cá»§a organization mÃ¬nh

**Process:**

```bash
POST /api/v1/auth/register
```

```json
{
  "email": "admin@company.com",
  "password": "SecurePassword123!",
  "full_name": "John Doe",
  "tenant_name": "ACME Corp",
  "tenant_domain": "acme.com"
}
```

**Validation:**
- âœ… Email unique check
- âœ… Password strength (min 8 chars, mixed case, numbers)
- âœ… Domain format validation

**Security Measures:**
```python
# Password hashing vá»›i bcrypt (cost factor 12)
hashed_password = bcrypt.hash(plain_password, rounds=12)

# JWT token chá»©a:
{
  "sub": "user_id",           # Subject (user ID)
  "tenant_id": "tenant_uuid", # Multi-tenant isolation
  "exp": 1234567890           # Expiration (30 min default)
}
```

### 2. User Login

**Endpoints:**

```bash
# Standard login (JSON)
POST /api/v1/auth/login
Content-Type: application/x-www-form-urlencoded

username=admin@demo.com
password=admin123
```

**Response:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "token_type": "bearer"
}
```

**Token Usage:**
```bash
# Táº¥t cáº£ protected endpoints cáº§n header:
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

### 3. Authorization & Permissions

**Role-Based Access Control (RBAC):**

| Role | Permissions |
|------|-------------|
| **Admin** | ToÃ n quyá»n trong tenant: manage users, avatars, videos, settings |
| **User** | Táº¡o/xem avatars vÃ  videos cá»§a chÃ­nh mÃ¬nh |
| **Viewer** | (Future) Chá»‰ xem, khÃ´ng táº¡o |

**Tenant Isolation:**
```python
# Má»i query tá»± Ä‘á»™ng filter theo tenant_id
async def get_current_user(token: str):
    payload = decode_jwt(token)
    return {
        "user_id": payload["sub"],
        "tenant_id": payload["tenant_id"]  # â† Isolation key
    }

# Example: Chá»‰ láº¥y avatars cá»§a tenant hiá»‡n táº¡i
avatars = db.query(Avatar).filter(
    Avatar.user_id == current_user["user_id"],
    Avatar.tenant_id == current_user["tenant_id"]  # â† Prevent cross-tenant access
)
```

### 4. Security Features

#### A. Password Security

```python
from passlib.context import CryptContext

pwd_context = CryptContext(
    schemes=["bcrypt"],
    deprecated="auto",
    bcrypt__rounds=12  # Cost factor
)

# Hash password
hashed = pwd_context.hash("user_password")

# Verify
is_valid = pwd_context.verify("user_password", hashed)
```

**Best Practices:**
- âœ… Bcrypt algorithm (industry standard)
- âœ… Cost factor 12 (balance security vs performance)
- âœ… Never store plain passwords
- âœ… Password rotation policy (TODO)

#### B. JWT Token Security

**Configuration:**
```python
# backend/app/core/config.py
SECRET_KEY = "your-256-bit-secret"  # â† MUST change in production
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30
```

**Token Structure:**
```json
{
  "sub": "uuid-user-id",
  "tenant_id": "uuid-tenant-id",
  "exp": 1707220800,
  "iat": 1707219000
}
```

**Security Considerations:**
- âœ… Short expiration (30 min)
- âœ… Signed with HMAC-SHA256
- âœ… Stateless (no server-side storage)
- âš ï¸ TODO: Refresh tokens for long sessions
- âš ï¸ TODO: Token blacklist for logout

#### C. CORS Protection

```python
# backend/app/main.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",    # Admin Portal
        "https://your-domain.com"   # Production
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**Production Settings:**
- âœ… Whitelist specific origins
- âœ… Enable credentials for cookies
- âŒ Disable `allow_origins=["*"]`

#### D. SQL Injection Protection

```python
# âœ… SAFE: SQLAlchemy ORM (parameterized queries)
user = db.query(User).filter(User.email == email).first()

# âŒ UNSAFE: Raw SQL with string interpolation
# db.execute(f"SELECT * FROM users WHERE email = '{email}'")
```

**All queries use:**
- âœ… SQLAlchemy ORM
- âœ… Prepared statements
- âœ… Type validation with Pydantic

#### E. File Upload Security

```python
# backend/app/services/storage_service.py

ALLOWED_IMAGE_TYPES = {"image/jpeg", "image/png", "image/webp"}
ALLOWED_AUDIO_TYPES = {"audio/mpeg", "audio/wav"}
MAX_FILE_SIZE = 10 * 1024 * 1024  # 10 MB

async def upload_file(file: UploadFile):
    # 1. Validate content type
    if file.content_type not in ALLOWED_IMAGE_TYPES:
        raise HTTPException(400, "Invalid file type")
    
    # 2. Check file size
    content = await file.read()
    if len(content) > MAX_FILE_SIZE:
        raise HTTPException(400, "File too large")
    
    # 3. Generate unique filename (prevent overwrite)
    filename = f"{uuid4()}.jpg"
    
    # 4. Upload to isolated storage
    storage.upload(bucket=tenant_id, filename=filename)
```

### 5. Demo Accounts

**Pre-seeded Data:**

| Email | Password | Role | Tenant |
|-------|----------|------|--------|
| `admin@demo.com` | `admin123` | Admin | Demo Tenant |
| `user@demo.com` | `user123` | User | Demo Tenant |

**Avatar IDs:**
| ID | Name | Photo | Status |
|----|------|-------|--------|
| `605f28ea-8094-4356-b8b3-09f7e2229425` | Demo Avatar | âœ… Uploaded | Ready |

### 6. Security Checklist

**Production Deployment:**

- [ ] **Change SECRET_KEY** to random 256-bit string
  ```bash
  python -c "import secrets; print(secrets.token_urlsafe(32))"
  ```

- [ ] **Enable HTTPS** for all endpoints
  ```nginx
  server {
      listen 443 ssl;
      ssl_certificate /path/to/cert.pem;
      ssl_certificate_key /path/to/key.pem;
  }
  ```

- [ ] **Set CORS origins** to production domains only
  ```python
  allow_origins=["https://your-app.com"]
  ```

- [ ] **Enable rate limiting** (TODO)
  ```python
  from slowapi import Limiter
  limiter = Limiter(key_func=get_remote_address)
  
  @app.post("/api/v1/auth/login")
  @limiter.limit("5/minute")  # Max 5 attempts per minute
  ```

- [ ] **Database SSL** connection
  ```env
  DATABASE_URL=postgresql://user:pass@host:5432/db?sslmode=require
  ```

- [ ] **Environment variables** khÃ´ng commit vÃ o Git
  ```bash
  # .gitignore
  .env
  .env.local
  ```

- [ ] **Audit logs** cho sensitive actions (TODO)
  ```python
  logger.info(f"User {user_id} deleted avatar {avatar_id}")
  ```

### 7. API Authentication Flow

**Example vá»›i curl:**

```bash
# 1. Login
TOKEN=$(curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin@demo.com&password=admin123" \
  | jq -r .access_token)

# 2. Use token to create avatar
curl -X POST http://localhost:8000/api/v1/avatars/ \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "My Avatar"}'

# 3. Upload photo
curl -X POST http://localhost:8000/api/v1/avatars/{avatar_id}/upload-photo \
  -H "Authorization: Bearer $TOKEN" \
  -F "photo=@my-photo.jpg"
```

**Token Expiration Handling:**
```javascript
// Frontend example
const response = await fetch('/api/v1/videos/', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});

if (response.status === 401) {
  // Token expired â†’ redirect to login
  window.location.href = '/login';
}
```

---

## ğŸ¤ Contributing

### Workflow

1. Fork repository
2. Create feature branch: `git checkout -b feature/amazing-feature`
3. Commit changes: `git commit -m 'Add amazing feature'`
4. Push to branch: `git push origin feature/amazing-feature`
5. Open Pull Request

### Code Style

- **Python**: Black formatter, isort, flake8
- **JavaScript**: ESLint + Prettier
- **Git Commits**: Conventional Commits

---

## ğŸ“„ License

This project is licensed under the MIT License - see LICENSE file for details.

---

## ğŸ™ Acknowledgments

- **FastAPI** - Amazing async framework
- **FFmpeg** - Video processing powerhouse
- **Heygen** - AI avatar platform
- **SadTalker** - Open-source lip-sync

---

## ğŸ“ Support

- **Issues**: GitHub Issues
- **Discussions**: GitHub Discussions
- **Email**: support@example.com

---

**Built with â¤ï¸ for better email communication**
